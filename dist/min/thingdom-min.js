/**
 * Thingdom API JavaScript Wrapper
 *
 * @author     Andrew Welters <andrew.welters@mts.com>
 * @author     F. Stephen Kirschbaum <stephen.kirschbaum@mts.com>
 * @copyright  2014-2015 MTS Systems
 * @license    http://www.opensource.org/licenses/mit-license.html MIT License
 * @version    0.1.2
 * @link       https://github.com/thingdomio/thingdom-js
 * @website    https://thingdom.io
 */
(function(){"use strict";var e=this;!function(e){var t=function(){var e=this,t=0,r=null,o=[],i=[],s=function(n,o){return function(i){return 0===t&&(r=i,t=n,o.forEach(function(e){e()})),e}};return e.state=function(){var e=["pending","fulfilled","rejected"];return function(){return e[t]}}(),e.resolve=s(1,o),e.reject=s(2,i),e.then=function(e,s){var a=n(),u=function(e,t){return"function"!=typeof e&&(e=t),function(){setTimeout(function(){try{a.resolve(e(r))}catch(t){a.reject(t)}})}};return e=u(e,function(e){return e}),s=u(s,function(e){throw e}),0===t?(o.push(e),i.push(s)):1===t?e():2===t&&s(),a.restrict()},e.restrict=function(){return{state:e.state,then:e.then}},e},n=function(){return new t};"function"==typeof e.define?e.define("deferred",[],function(){return n}):e.deferred=n}(e),function(t){var n=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0")},function(){return new ActiveXObject("MSXML2.XMLHTTP")}],r=null,o=Object.prototype.hasOwnProperty,i=Array.prototype.forEach,s=function(e,t,n){if(null!==e)if(i&&e.forEach===i)e.forEach(t,n);else if(e.length===+e.length){for(var r=0,s=e.length;s>r;r++)if(r in e&&t.call(n,e[r],r,e)===breaker)return}else for(var a in e)if(o.call(e,a)&&t.call(n,e[a],a,e)===breaker)return},a=function(e){return s(Array.prototype.slice.call(arguments,1),function(t){for(var n in t)void 0!==t[n]&&(e[n]=t[n])}),e};t.xhr=function(){if(null!==r)return r();for(var e=0,t=n.length;t>e;e++)try{var o=n[e],i=o();if(null!==i)return r=o,i}catch(s){continue}return function(){}},t._xhrResp=function(e){switch(e.getResponseHeader("Content-Type").split(";")[0]){case"text/xml":return e.responseXML;case"text/json":case"application/json":case"text/javascript":case"application/javascript":case"application/x-javascript":return JSON.parse(e.responseText);default:return e.responseText}},t._formData=function(e){var t=[],n=/%20/g;for(var r in e)t.push(encodeURIComponent(r).replace(n,"+")+"="+encodeURIComponent(e[r].toString()).replace(n,"+"));return t.join("&")},t.ajax=function(n){var r=t.xhr(),o,i=0,s=e.deferred();n=a({userAgent:"XMLHttpRequest",lang:"en",type:"GET",data:null,dataType:"application/x-www-form-urlencoded"},n),n.timeout&&(o=setTimeout(function(){r.abort(),n.timeoutFn&&n.timeoutFn(n.url)},n.timeout));var u=function(e){n.success(e)},c=function(e){n.error(e)};s.then(u,c),r.onreadystatechange=function(){4===r.readyState?(o&&clearTimeout(o),r.status<300?(n.dataType.indexOf("json")>=0&&(r.responseJSON=JSON.parse(r.responseText)),n.success&&("pending"===s.state()?s.resolve(t._xhrResp(r)):n.success(t._xhrResp(r),"success",r))):n.error&&("pending"===s.state()?s.reject(r.statusText):n.error(r,r.status,r.statusText)),n.complete&&n.complete(r,r.statusText)):n.progress&&n.progress(++i)};var f=n.url,p=null,d="POST"===n.type||"PUT"===n.type;if(!d&&n.data&&(f+="?"+t._formData(n.data)),r.open(n.type,f),d){var l=n.dataType.indexOf("json")>=0;p=l?JSON.stringify(n.data):t._formData(n.data),r.setRequestHeader("Content-Type",l?"application/json":"application/x-www-form-urlencoded")}r.send(p)}}(e);var t=function(t){var n=this,r="none",o="https://api.thingdom.io/1.1/",i,s;this.lastError=null,"undefined"!=typeof t&&(i=t);var a=function(e){n.lastError=e},u=function(t,n,s){var u=function(r){var i=t,u=n,c=s;u.token=r.application_token,e.ajax({url:o+i,withCredentials:!0,type:"POST",dataType:"json",data:u,success:function(){},error:function(){},complete:function(e){return"token_expired"===e.responseJSON.response?void a("Unable to post. Thingdom API response: "+e.responseJSON.msg):void c(e.responseJSON)}})};e.ajax({url:o+t,withCredentials:!0,type:"POST",dataType:"json",data:n,success:function(e){"token_expired"!==e.response&&s(e)},error:function(e){s(e)},complete:function(e){"token_expired"===e.responseJSON.response&&f(i,r,u)}})},c=function(e){s=e},f=function(t,n,r){var o;"function"==typeof r&&(o=e.deferred(),o.then(r,r));var i={api_secret:t,device_secret:n},s=function(e){c(e.application_token),"undefined"!=typeof o&&o.resolve(e)};u("token",i,s)};f(i,r);var p=function(e,t){var n=e;this.thing_code=t;var r=function(e,t){var r={};if("undefined"==typeof e)return void a("feed: You must provide a message");"undefined"!=typeof t&&(r.feed_category=t),r.token=s,r.thing_id=n,r.message=e;var o=function(e){return"success"!==e.response?void a("feed: Error posting to /feed. Thingdom API response: "+e.msg):void 0};u("feed",r,o)},o=function(e,t,r){var o={};if("undefined"==typeof e||"undefined"==typeof t)return void a("status: You must specify both a key and value");o.token=s,o.thing_id=n,o.status_array="undefined"!=typeof r?[{name:e,value:t,unit:r}]:[{name:e,value:t}];var i=function(e){"success"!==e.response&&a("status: Error posting to /status. Thingdom API response: "+e.msg)};u("status",o,i)},i=function(e){"object"!=typeof e&&a("statusArray: You must pass an array containing one or more objects with appropriate key value pairs: [ { name: key, value: val, unit: unit } ]");var t={token:s,thing_id:n,status_array:e},r=function(e){"success"!==e.response&&a("statusArray: Error posting to /status. Thingdom API response: "+e.msg)};u("status",t,r)};return this.feed=r,this.status=o,this.statusArray=i,this};return this.getThing=function(e,t,n){if("undefined"==typeof r||"undefined"==typeof i||"undefined"==typeof s)return void a("getThing: Thingdom requires a valid API Secret. Log in at dev.thingdom.io for yours.");if("function"!=typeof n)return void a("getThing: You must provide a valid callback to get instantiated Thing. Try a good variation of: function( newThing ) { thing = newThing; } ");if("undefined"==typeof e)return void a("getThing: You must define the name for your Thing");var o={name:e};"undefined"!=typeof t&&(o.product_type=t),o.token=s;var c=function(e){return"success"!==e.response?void a("getThing: Error posting to /thing. Error from Thingdom API: "+e.msg):void n(new p(e.thing_id,e.code))};u("thing",o,c)},n};e.Thingdom=t}).call(this);